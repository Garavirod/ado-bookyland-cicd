resources:
  - repo: self

variables:
  - template: vars/global.yml
  - template: vars/dev.yml

pool:
  name: Default

stages:
  - stage: TerraformValidate
    displayName: Terraform validation
    jobs:
      - job: validate
        displayName: Validate terraform
        continueOnError: false
        steps:
          # Terraform install and init
          - template: steps/dev-terraform-install-init.yml

          # Terraform validate
          - task: TerraformCLI@2
            displayName: terraform validate
            inputs:
              command: "validate"
              workingDirectory: "infra/setup"
              allowTelemetryCollection: true

  - stage: TerraformDeploy
    condition: succeeded('TerraformValidate')
    dependsOn: TerraformValidate
    jobs:
      - job: Deploy
        displayName: Deploy terraform
        steps:
          # Terraform install and init
          - template: steps/dev-terraform-install-init.yml

          # Terraform plan and apply
          - template: steps/dev-terraform-plan-apply.yml
          

